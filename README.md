# Metin2CMS Exploit

Hello,

Since someone asked me about injections in Metin2CMS (targeted CMS: https://metin2cms.cf/), I quickly looked at the code of the CMS mentioned. I also noticed a critical exploit that enables code injections.

 

The file *include\functions\sendEmail.php* contains the following code:

```php
$site_name = $_SERVER['SERVER_NAME'];
if ($site_name == 'localhost' || $site_name == '127.0.0.1') $site_name = 'metin2cms.cf';
```
 

As of Apache 2, `$_SERVER['SERVER_NAME']` can be transmitted from the client to the server via the http header Host (like for `$_SERVER['HTTP_HOST']` too).

 

An email is sent in the same file using PHPMailer and the sender is set as follows:

 
```php
$mail->SetFrom($email_name . '@' . $site_name, $site_title);
```
 

The script *include\mailer\PHPMailer.php* validates the sender as follows:

 
```php
if (!empty($this->Sender) and static::validateAddress($this->Sender))
{
    if (self::isShellSafe($this->Sender))
    {
        $params = sprintf('-f%s', $this->Sender);
    }
}
```

The validateAddress function uses `FILTER_VALIDATE_EMAIL` according to RFC 822, which is not sufficient to check e-mails.

 

The isShellSafe function uses escapeshellcmd, which prevents additional commands from being executed, but it is still possible to pass additional parameters / flags that allow the execution of PHP code.

 

I wrote with Ionut and thanks to him he already released a full solution for this here: https://github.com/IonutPopescuRO/Metin2CMS/commit/b81859d7962d3054d18f1cbebff9216d3754f507

 

Fix:

 

Remove:

 
```php
$email_name = 'noreplay';

$site_name = $_SERVER['SERVER_NAME'];
if ($site_name == 'localhost' || $site_name == '127.0.0.1')
	$site_name = 'metin2cms.cf';
```

Replace:

 
```php
$mail->SetFrom($email_name . '@' . $site_name, $site_title);
$mail->AddReplyTo($email_name . "@" . $site_name, $site_title);
```
 

With:

```php
$mail->SetFrom($email_username, $site_title);
$mail->AddReplyTo($email_username, $site_title);
```
 

Btw, i would not suggest setting the variable through Apache using `ServerName` and `UseCanonicalName`. These variables should not be used in productive environments.
